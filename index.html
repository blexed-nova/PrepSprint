<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PrepSprint AI Lab üß™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary: #1877f2; --bg: #f0f2f5; --card-bg: #ffffff; --text: #1c1e21; --success: #2ecc71; --danger: #e74c3c; --accent: #8e44ad; }
        body.dark-mode { --bg: #18191a; --card-bg: #242526; --text: #e4e6eb; }
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background-color: var(--bg); color: var(--text); max-width: 850px; margin: auto; transition: 0.3s; }
        .container { background: var(--card-bg); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
        .hud { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(90deg, var(--primary), var(--accent)); color: white; padding: 15px 25px; border-radius: 15px; margin-bottom: 25px; }
        .rank-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 8px; font-size: 0.8em; text-transform: uppercase; }
        .actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 30px; }
        button { cursor: pointer; padding: 15px; border: none; border-radius: 12px; background-color: var(--primary); color: white; font-weight: 600; transition: 0.3s; }
        button:hover { filter: brightness(1.2); transform: translateY(-2px); }
        #output { min-height: 250px; border: 2px dashed #444; padding: 30px; border-radius: 15px; background: rgba(0,0,0,0.03); display: flex; flex-direction: column; justify-content: center; }
        .ai-lab { margin-top: 30px; padding: 20px; border: 1px solid var(--accent); border-radius: 15px; background: rgba(142, 68, 173, 0.05); }
        .drop-zone { border: 2px dashed var(--accent); padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; }
        .loading-bar-container { width: 100%; background: #444; height: 6px; border-radius: 3px; margin-top: 15px; display: none; overflow: hidden; }
        .loading-bar { width: 0%; height: 100%; background: var(--accent); transition: width 0.4s; }
        .ai-response-box { white-space: pre-wrap; font-size: 0.95em; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; margin-top: 15px; border-left: 5px solid var(--accent); }
    </style>
</head>
<body class="dark-mode">

<div id="authOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000;">
    <div style="background: var(--card-bg); padding: 40px; border-radius: 20px; text-align: center; border: 1px solid var(--primary);">
        <h2>PrepSprint Neural Link</h2>
        <input type="text" id="userName" placeholder="Enter Pilot Name" style="padding: 12px; border-radius: 8px; border: 1px solid #444; background: #111; color: white; width: 250px;"><br><br>
        <button onclick="initProfile()" style="width: 100%;">Establish Connection</button>
    </div>
</div>

<div class="container">
    <div class="hud">
        <div>
            <span id="nameDisplay" style="font-size: 1.2em; font-weight: bold;">Pilot</span> 
            <span id="rankDisplay" class="rank-badge">Rookie</span>
        </div>
        <div style="text-align: right;">
            <div>üî• <span id="streakDisplay">1</span> Day Streak</div>
            <div style="font-size: 1.1em;">üèÜ <span id="scoreDisplay">0</span> XP</div>
        </div>
    </div>

    <div class="actions">
        <button onclick="showMode('flash')">üî• Flashcards</button>
        <button onclick="showMode('mcq')">üéØ MCQ Sprint</button>
        <button onclick="showMode('tough')">üòà Tough Mode</button>
        <button onclick="toggleTheme()" style="background: #333;">üåì Theme</button>
    </div>

    <div id="output">
        <p style="text-align: center; color: #888;">Ready. Upload a file to the AI Lab below.</p>
    </div>

    <div class="ai-lab">
        <h3>üß™ Neural AI Question Lab</h3>
        <p style="font-size: 0.85em; opacity: 0.8;">Upload PDF/Image. AI will generate a unique engineering problem.</p>
        
        <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
            <p id="uploadText">üìÅ Click to upload PDF or Image</p>
            <input type="file" id="fileInput" hidden onchange="handleAIUpload()" accept="image/*,application/pdf">
            <div id="progressContainer" class="loading-bar-container">
                <div id="progressBar" class="loading-bar"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // üîë LIVE API KEY
    const GEMINI_API_KEY = "AIzaSyCtVlYVG0Xl84tgKeQtwNO6pBhCyup74Tw";

    let state = { name: "", score: 0, streak: 1, rank: "Rookie", lastSeen: "" };

    function initProfile() {
        const n = document.getElementById('userName').value;
        if(!n) return;
        state.name = n;
        state.lastSeen = new Date().toDateString();
        localStorage.setItem('prepsprint_pro', JSON.stringify(state));
        document.getElementById('authOverlay').style.display = 'none';
        refreshUI();
    }

    window.onload = () => {
        const saved = localStorage.getItem('prepsprint_pro');
        if(saved) {
            state = JSON.parse(saved);
            document.getElementById('authOverlay').style.display = 'none';
            refreshUI();
        }
    }

    function refreshUI() {
        document.getElementById('nameDisplay').innerText = state.name;
        document.getElementById('scoreDisplay').innerText = state.score;
        document.getElementById('streakDisplay').innerText = state.streak;
        if(state.score > 1000) state.rank = "Grandmaster";
        else if(state.score > 500) state.rank = "Specialist";
        else if(state.score > 100) state.rank = "Scholar";
        document.getElementById('rankDisplay').innerText = state.rank;
        localStorage.setItem('prepsprint_pro', JSON.stringify(state));
    }

    function addXP(amt) {
        state.score += amt;
        refreshUI();
    }

    async function handleAIUpload() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        const text = document.getElementById('uploadText');
        const barContainer = document.getElementById('progressContainer');
        const bar = document.getElementById('progressBar');

        if (!file) return;

        text.innerText = "‚è≥ Processing File...";
        barContainer.style.display = "block";
        bar.style.width = "40%";

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const base64Data = reader.result.split(',')[1];
            const mime = file.type || "application/pdf";
            
            bar.style.width = "70%";
            text.innerText = "üß† Analyzing with Gemini 1.5 Flash...";

            try {
                // FIXED ENDPOINT TO v1 STABLE
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "Read this file. Generate one engineering MCQ. Question, Options A-D, Answer, and Explanation." },
                                { inline_data: { mime_type: mime, data: base64Data } }
                            ]
                        }]
                    })
                });

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error.message);
                }

                const aiOutput = result.candidates[0].content.parts[0].text;
                bar.style.width = "100%";

                setTimeout(() => {
                    text.innerText = "‚úÖ Analysis Complete";
                    barContainer.style.display = "none";
                    displayResult(aiOutput);
                }, 600);

            } catch (err) {
                console.error("STABLE ERROR LOG:", err);
                text.innerText = "‚ùå Neural Error: " + err.message.substring(0, 40);
                barContainer.style.display = "none";
            }
        };
    }

    function displayResult(content) {
        document.getElementById('output').innerHTML = `
            <div style="text-align: left;">
                <h4 style="color: var(--accent); margin-bottom: 5px;">üß¨ AI Generated Content</h4>
                <div class="ai-response-box">${content}</div>
                <button style="margin-top: 15px; width: 100%; background: var(--success);" onclick="addXP(50); this.innerText='‚úÖ Done (+50 XP)'">Mark as Solved</button>
            </div>
        `;
    }

    function showMode(type) {
        let out = document.getElementById('output');
        if(type === 'flash') {
            out.innerHTML = `<h3>Flashcard</h3><p>What is the SI unit of Inductance?</p><button onclick="addXP(5); this.innerText='Henry (H) +5 XP'">Show Answer</button>`;
        } else if (type === 'mcq') {
            out.innerHTML = `<h3>MCQ</h3><p>Which is a vector?</p><button onclick="addXP(10); this.parentElement.innerHTML='‚úÖ Force (+10 XP)'">Force</button> <button onclick="alert('Try again!')">Mass</button>`;
        } else if (type === 'tough') {
            out.innerHTML = `<h3>üòà Tough Mode</h3><p>Calculate Power if V=220V and I=0.5A</p><input type="number" id="tAns" style="padding:10px; border-radius:8px; border:1px solid #444; background:#111; color:white;"><br><br><button onclick="checkT()">Submit</button>`;
        }
    }

    function checkT() {
        if(document.getElementById('tAns').value == 110) {
            addXP(100);
            document.getElementById('output').innerHTML = "<h2 style='color:var(--success)'>üî• SYSTEM UNLOCKED! +100 XP</h2>";
        } else { alert("Wrong! P = V * I"); }
    }

    function toggleTheme() { document.body.classList.toggle('dark-mode'); }
</script>
</body>
</html>
